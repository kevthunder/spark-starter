(function(){var t,n,e,i,r,o,s,u=[].slice,a=[].indexOf||function(t){for(var n=0,e=this.length;n<e;n++)if(n in this&&this[n]===t)return n;return-1};"undefined"!=typeof o&&null!==o||(o={}),n=function(){function t(t,n,e){this.event=t,this.target=n,this.callback=e,this.binded=!1}return t.prototype.bind=function(){return this.binded||this.target.addListener(this.event,this.callback),this.binded=!0},t.prototype.unbind=function(){return this.binded&&this.target.removeListener(this.event,this.callback),this.binded=!1},t.prototype.equals=function(t){return t.event===this.event&&t.target===this.target&&t.callback===this.callback},t}(),null!=o&&(o.EventBind=n),s=function(t,n){var e,i;return i=t.findIndex(n),i>-1?(e=t[i],t.splice(i,1),e):null},e=function(){function t(t,n){this.obj=t,this.property=n,this.invalidationEvents=[],this.recycled=[],this.invalidateCallback=function(t){return function(){return t.invalidate(),null}}(this)}return t.prototype.invalidate=function(){var t;return t="invalidate"+this.property.charAt(0).toUpperCase()+this.property.slice(1),null!=this.obj[t]?this.obj[t]():this.obj[this.property]=null},t.prototype.event=function(t,e){if(null==e&&(e=this),!this.invalidationEvents.some(function(n){return n.event===t&&n.target===e}))return this.invalidationEvents.push(s(this.recycled,function(n){return n.event===t&&n.target===e})||new n(t,e,this.invalidateCallback))},t.prototype.value=function(t,n,e){return null==e&&(e=this),this.event(n,e),t},t.prototype.prop=function(t,n){return null==n&&(n=this),this.value(n[t],t+"Changed",n)},t.prototype.isEmpty=function(){return 0===this.invalidationEvents.length},t.prototype.bind=function(){return this.invalidationEvents.forEach(function(t){return t.bind()})},t.prototype.recycle=function(t){var n,e;return this.recycled=this.invalidationEvents,this.invalidationEvents=[],n=function(t){return function(){return t.recycled.forEach(function(t){return t.unbind()}),t.recycled=[]}}(this),"function"==typeof t?t.length>1?t(this,n):(e=t(this),n(),e):n},t.prototype.unbind=function(){return this.invalidationEvents.forEach(function(t){return t.unbind()})},t}(),null!=o&&(o.Invalidator=e),r=function(){function t(t,n){this.property=t,this.obj=n,this.value=this.property.options.default,this.calculated=!1}return t.prototype.get=function(){return this.property.options.get===!1?void 0:"function"==typeof this.property.options.get?this.property.options.get.call(this.obj):(this.calculated||this.calcul(),this.value)},t.prototype.set=function(t){var n;return this.property.options.set===!1||("function"==typeof this.property.options.set?this.property.options.set.call(this.obj,t):(t=this.ingest(t),this.value!==t&&(n=this.value,this.value=t,this.changed(n)))),this},t.prototype.invalidate=function(){var t;if(this.calculated)if(this.calculated=!1,this.isImmediate()){if(t=this.value,this.get(),this.value!==t)return this.changed(t)}else if(null!=this.invalidator)return this.invalidator.unbind()},t.prototype.destroy=function(){if(null!=this.invalidator)return this.invalidator.unbind()},t.prototype.calcul=function(){return"function"==typeof this.property.options.calcul&&(this.invalidator||(this.invalidator=new e(this.obj,this.property.name)),this.invalidator.recycle(function(t){return function(n){return t.value=t.property.options.calcul.call(t.obj,n),n.isEmpty()?t.invalidator=null:n.bind()}}(this))),this.calculated=!0,this.value},t.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest?t=this.property.options.ingest.call(this.obj,t):t},t.prototype.changed=function(t){if("function"==typeof this.property.options.change&&this.property.options.change.call(this.obj,t),"function"==typeof this.obj.emitEvent)return this.obj.emitEvent(this.property.getChangeEventName(),[t])},t.prototype.isImmediate=function(){return this.property.options.immediate===!0||"function"==typeof this.obj.getListeners&&this.obj.getListeners(this.property.getChangeEventName()).length>0},t}(),null!=o&&(o.PropertyInstance=r),i=function(){function t(t,n){var e;this.name=t,this.options=n,e=!1}return t.prototype.bind=function(t){var n,e;return e=this,n=this.name.charAt(0).toUpperCase()+this.name.slice(1),Object.defineProperty(t,this.name,{get:function(){return e.getInstance(this).get()},set:function(t){return e.getInstance(this).set(t)}}),t["get"+n]=function(){return e.getInstance(this).get()},t["set"+n]=function(t){return e.getInstance(this).set(t),this},t["invalidate"+n]=function(){return e.getInstance(this).invalidate(),this},t._properties=(t._properties||[]).concat([e]),this.checkFunctions(t),this.checkAfterAddListener(t)},t.prototype.checkFunctions=function(n){var e,i,r,o;this.checkAfterAddListener(n),r=t.fn,o=[];for(i in r)e=r[i],"undefined"==typeof n[i]?o.push(n[i]=e):o.push(void 0);return o},t.prototype.checkAfterAddListener=function(n){var e;if("function"==typeof n.addListener&&"undefined"==typeof n.afterAddListener)return n.afterAddListener=t.optionalFn.afterAddListener,e=n.addListener,n.addListener=function(t,n){return this.addListener.overrided(t,n),this.afterAddListener(t)},n.addListener.overrided=e},t.prototype.getInstanceVarName=function(){return this.options.instanceVarName||"_"+this.name},t.prototype.isInstantiated=function(t){return null!=t[this.getInstanceVarName()]},t.prototype.getInstance=function(t){var n;return n=this.getInstanceVarName(),this.isInstantiated(t)||(t[n]=new r(this,t)),t[n]},t.prototype.getChangeEventName=function(){return this.options.changeEventName||this.name+"Changed"},t.fn={getProperty:function(t){return this._properties.find(function(n){return n.name===t})},getPropertyInstance:function(t){var n;if(n=this.getProperty(t))return n.getInstance(this)},getProperties:function(){return this._properties.slice()},getPropertyInstances:function(){return this._properties.map(function(t){return function(n){return n.getInstance(t)}}(this))},getInstantiatedProperties:function(){return this._properties.filter(function(t){return function(n){return n.isInstantiated(t)}}(this)).map(function(t){return function(n){return n.getInstance(t)}}(this))},destroyProperties:function(){return this.getInstantiatedProperties().forEach(function(t){return function(t){return t.destroy()}}(this)),this._properties=[],!0}},t.optionalFn={afterAddListener:function(t){return this._properties.forEach(function(n){return function(e){if(e.getChangeEventName()===t)return e.getInstance(n).get()}}(this))}},t}(),null!=o&&(o.Property=i),t=function(){function t(){}return t.elementKeywords=["extended","included"],t.prototype.tap=function(t){var n;return n=Array.prototype.slice.call(arguments),"function"==typeof t?t.apply(this,n.slice(1)):this[t].apply(this,n.slice(1)),this},t.prototype.callback=function(t){return null==this._callbacks&&(this._callbacks={}),null!=this._callbacks[t]?this._callbacks[t]:this._callbacks[t]=function(n){return function(){var e;return e=1<=arguments.length?u.call(arguments,0):[],n[t].call(n,e),null}}(this)},t.extend=function(n){var e,i,r;for(e in n)r=n[e],a.call(t.elementKeywords,e)<0&&(this[e]=r);return null!=(i=n.extended)&&i.apply(this),this},t.include=function(n){var e,i,r;for(e in n)r=n[e],a.call(t.elementKeywords,e)<0&&(this.prototype[e]=r);return null!=(i=n.included)&&i.apply(this),this},t.property=function(t,n){return new i(t,n).bind(this.prototype)},t.properties=function(t){var n,e,i;i=[];for(e in t)n=t[e],i.push(this.property(e,n));return i},t}(),null!=o&&(o.Element=t),"undefined"!=typeof module&&null!==module?module.exports=o:this.Spark=o}).call(this);