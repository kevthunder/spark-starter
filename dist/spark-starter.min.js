(function(){var t,n,e,i,r,l,s,o,u=[].slice,a=[].indexOf||function(t){for(var n=0,e=this.length;n<e;n++)if(n in this&&this[n]===t)return n;return-1};"undefined"!=typeof i&&null!==i||(i={}),n=function(){function t(t,n,e){this.event=t,this.target=n,this.callback=e,this.binded=!1}return t.prototype.bind=function(){return this.binded||this.target.addListener(this.event,this.callback),this.binded=!0},t.prototype.unbind=function(){return this.binded&&this.target.removeListener(this.event,this.callback),this.binded=!1},t.prototype.equals=function(t){return t.event===this.event&&t.target===this.target&&t.callback===this.callback},t}(),null!=i&&(i.EventBind=n),s=function(t,n){var e,i;return i=t.findIndex(n),i>-1?(e=t[i],t.splice(i,1),e):null},e=function(){function t(t,n){this.obj=t,this.property=n,this.invalidationEvents=[],this.recycled=[],this.invalidateCallback=function(t){return function(){return t.invalidate(),null}}(this)}return t.prototype.invalidate=function(){var t;return t="invalidate"+this.property.charAt(0).toUpperCase()+this.property.slice(1),null!=this.obj[t]?this.obj[t]():this.obj[this.property]=null},t.prototype.fromEvent=function(t,e){if(null==e&&(e=this),!this.invalidationEvents.some(function(n){return n.event===t&&n.target===e}))return this.invalidationEvents.push(s(this.recycled,function(n){return n.event===t&&n.target===e})||new n(t,e,this.invalidateCallback))},t.prototype.fromValue=function(t,n,e){return null==e&&(e=this),this.fromEvent(n,e),t},t.prototype.fromProperty=function(t,n){return null==n&&(n=this),this.fromValue(n[t],t+"Changed",n)},t.prototype.isEmpty=function(){return 0===this.invalidationEvents.length},t.prototype.bind=function(){return this.invalidationEvents.forEach(function(t){return t.bind()})},t.prototype.recycle=function(t){var n,e;return this.recycled=this.invalidationEvents,this.invalidationEvents=[],n=function(t){return function(){return t.recycled.forEach(function(t){return t.unbind()}),t.recycled=[]}}(this),"function"==typeof t?t.length>1?t(this,n):(e=t(this),n(),e):n},t.prototype.unbind=function(){return this.invalidationEvents.forEach(function(t){return t.unbind()})},t}(),null!=i&&(i.Invalidator=e),r=function(t){var n,e,i;if((e=t.match(/^changed(\w*)$/))&&(n=e[1],i=n.charAt(0).toLowerCase()+n.slice(1),"function"==typeof this["invalidate"+n]&&this[i+"Calculated"]===!1))return this["get"+n]()},o=function(t,n,e){var i,s;if(i=n.charAt(0).toUpperCase()+n.slice(1),null!=e&&(t["calcul"+i]=e),null!=t["calcul"+i]&&(t[n+"Calculated"]=!1,t["invalidate"+i]=function(){var t;if(this[n+"Calculated"])if(this[n+"Calculated"]=!1,this["immediate"+i]||"function"==typeof this.getListeners&&this.getListeners(n+"Changed").length>0){if(t=this["_"+n],this["get"+i](),t!==this["_"+n])return l(this,n,t)}else if(null!=this[n+"Invalidator"])return this[n+"Invalidator"].unbind()},"function"==typeof this.addListener&&"function"!=typeof this.afterAddListener))return this.afterAddListener=r,s=this.addListener,this.addListener=function(t,n){return s(t,n),this.afterAddListener(t)}},l=function(t,n,e){if("function"==typeof t[n+"Changed"]&&t[n+"Changed"](e),"function"==typeof t.emitEvent)return t.emitEvent(n+"Changed",[e])},t=function(){function t(){}return t.elementKeywords=["extended","included"],t.prototype.tap=function(t){var n;return n=Array.prototype.slice.call(arguments),"function"==typeof t?t.apply(this,n.slice(1)):this[t].apply(this,n.slice(1)),this},t.prototype.callback=function(t){return null==this._callbacks&&(this._callbacks={}),null!=this._callbacks[t]?this._callbacks[t]:this._callbacks[t]=function(n){return function(){var e;return e=1<=arguments.length?u.call(arguments,0):[],n[t].call(n,e),null}}(this)},t.extend=function(n){var e,i,r;for(e in n)r=n[e],a.call(t.elementKeywords,e)<0&&(this[e]=r);return null!=(i=n.extended)&&i.apply(this),this},t.include=function(n){var e,i,r;for(e in n)r=n[e],a.call(t.elementKeywords,e)<0&&(this.prototype[e]=r);return null!=(i=n.included)&&i.apply(this),this},t.property=function(t,n){var i;return i=t.charAt(0).toUpperCase()+t.slice(1),null!=n.default?this.prototype["_"+t]=n.default:this.prototype["_"+t]=null,null!=n.get&&n.get===!1||(null!=n.get?this.prototype["get"+i]=n.get:(this.prototype["immediate"+i]=n.immediate===!0,o(this.prototype,t,n.calcul),this.prototype["get"+i]=function(){return"function"!=typeof this["calcul"+i]||this[t+"Calculated"]||(null==this[t+"Invalidator"]&&(this[t+"Invalidator"]=new e(this,t)),this[t+"Invalidator"].recycle(function(n){return function(e){return n["_"+t]=n["calcul"+i](e),e.isEmpty()?n[t+"Invalidator"]=null:e.bind()}}(this)),this[t+"Calculated"]=!0),this["_"+t]}),n.get=function(){return this["get"+i]()}),null!=n.set&&n.set===!1||(null!=n.set?this.prototype["set"+i]=n.set:(null!=n.change&&(this.prototype[t+"Changed"]=n.change),null!=n.ingest&&(this.prototype["ingest"+i]=n.ingest),this.prototype["set"+i]=function(n){var e;return"function"==typeof this["ingest"+i]&&(n=this["ingest"+i](n)),this["_"+t]!==n&&(e=this["_"+t],this["_"+t]=n,l(this,t,e)),this}),n.set=function(t){return this["set"+i](t)}),Object.defineProperty(this.prototype,t,n)},t.properties=function(t){var n,e,i;i=[];for(e in t)n=t[e],i.push(this.property(e,n));return i},t}(),null!=i&&(i.Element=t),"undefined"!=typeof module&&null!==module?module.exports=i:this.Spark=i}).call(this);