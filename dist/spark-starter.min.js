(function(){var t,n=[].slice,e=function(t,n){function e(){this.constructor=t}for(var r in n)i.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},i={}.hasOwnProperty,r=[].indexOf||function(t){for(var n=0,e=this.length;n<e;n++)if(n in this&&this[n]===t)return n;return-1};t="undefined"!=typeof module&&null!==module?module.exports={}:(null==this.Spark&&(this.Spark={}),this.Spark),function(n){t.Collection=n(),t.Collection.definition=n}(function(){return function(){function t(t){null!=t?"function"==typeof t.toArray?this._array=t.toArray():Array.isArray(t)?this._array=t:this._array=[t]:this._array=[]}return t.prototype.changed=function(){},t.prototype.get=function(t){return this._array[t]},t.prototype.set=function(t,n){var e;return this._array[t]!==n&&(e=this.toArray(),this._array[t]=n,this.changed(e)),n},t.prototype.add=function(t){if(!this._array.includes(t))return this.push(t)},t.prototype.remove=function(t){var n,e;if(-1!==(n=this._array.indexOf(t)))return e=this.toArray(),this._array.splice(n,1),this.changed(e)},t.prototype.toArray=function(){return this._array.slice()},t.prototype.count=function(){return this._array.length},t.readFunctions=["every","find","findIndex","forEach","includes","indexOf","join","lastIndexOf","map","reduce","reduceRight","some","toString"],t.readListFunctions=["concat","filter","slice"],t.writefunctions=["pop","push","reverse","shift","sort","splice","unshift"],t.readFunctions.forEach(function(e){return t.prototype[e]=function(){var t,i;return t=1<=arguments.length?n.call(arguments,0):[],(i=this._array)[e].apply(i,t)}}),t.readListFunctions.forEach(function(e){return t.prototype[e]=function(){var t,i;return t=1<=arguments.length?n.call(arguments,0):[],this.copy((i=this._array)[e].apply(i,t))}}),t.writefunctions.forEach(function(e){return t.prototype[e]=function(){var t,i,r,o;return t=1<=arguments.length?n.call(arguments,0):[],i=this.toArray(),o=(r=this._array)[e].apply(r,t),this.changed(i),o}}),t.newSubClass=function(t,n){var i;return"object"==typeof t?(i=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n}(this),Object.assign(i.prototype,t),new i(n)):new this(n)},t.prototype.copy=function(t){return null==t&&(t=this.toArray()),new this.constructor(t)},t.prototype.equals=function(t){return this.count()===(tyepeof("function"===t.count)?t.count():t.length)&&this.every(function(n,e){return t[e]===n})},t.prototype.getAddedFrom=function(t){return this._array.filter(function(n){return!t.includes(n)})},t.prototype.getRemovedFrom=function(t){return t.filter(function(t){return function(n){return!t.includes(n)}}(this))},t}()}),function(n){t.EventBind=n(),t.EventBind.definition=n}(function(){return function(){function t(t,n,e){this.event=t,this.target=n,this.callback=e,this.binded=!1}return t.prototype.bind=function(){if(!this.binded)if("function"==typeof this.target.addEventListener)this.target.addEventListener(this.event,this.callback);else if("function"==typeof this.target.addListener)this.target.addListener(this.event,this.callback);else{if("function"!=typeof this.target.on)throw new Error("No function to add event listeners was found");this.target.on(this.event,this.callback)}return this.binded=!0},t.prototype.unbind=function(){if(this.binded)if("function"==typeof this.target.removeEventListener)this.target.removeEventListener(this.event,this.callback);else if("function"==typeof this.target.removeListener)this.target.removeListener(this.event,this.callback);else{if("function"!=typeof this.target.off)throw new Error("No function to remove event listeners was found");this.target.off(this.event,this.callback)}return this.binded=!1},t.prototype.equals=function(t){return t.event===this.event&&t.target===this.target&&t.callback===this.callback},t.prototype.match=function(t,n){return t===this.event&&n===this.target},t.checkEmitter=function(t,n){if(null==n&&(n=!0),"function"==typeof t.addEventListener||"function"==typeof t.addListener||"function"==typeof t.on)return!0;if(n)throw new Error("No function to add event listeners was found");return!1},t}()}),function(n){t.Invalidator=n(),t.Invalidator.definition=n}(function(n){var e,i;return null==n&&(n={}),e=n.hasOwnProperty("EventBind")?n.EventBind:t.EventBind,i=function(t,n){var e,i;return i=t.findIndex(n),i>-1?(e=t[i],t.splice(i,1),e):null},function(){function t(t,n){this.property=t,this.obj=null!=n?n:null,this.invalidationEvents=[],this.recycled=[],this.unknowns=[],this.strict=this.constructor.strict,this.invalidateCallback=function(t){return function(){return t.invalidate(),null}}(this)}return t.strict=!0,t.prototype.invalidate=function(){var t;return"function"==typeof this.property.invalidate?this.property.invalidate():(t="invalidate"+this.property.charAt(0).toUpperCase()+this.property.slice(1),"function"==typeof this.obj[t]?this.obj[t]():this.obj[this.property]=null)},t.prototype.unknown=function(){return"function"==typeof this.property.unknown?this.property.unknown():this.invalidate()},t.prototype.addEventBind=function(t,n,r){if(!this.invalidationEvents.some(function(e){return e.match(t,n)}))return this.invalidationEvents.push(i(this.recycled,function(e){return e.match(t,n)})||new e(t,n,r))},t.prototype.getUnknownCallback=function(t,n){return function(e){return function(){if(!e.unknowns.some(function(e){return e.prop===t&&e.target===n}))return e.unknowns.push({prop:t,target:n}),e.unknown()}}(this)},t.prototype.event=function(t,n){if(null==n&&(n=this.obj),this.checkEmitter(n))return this.addEventBind(t,n,this.invalidateCallback)},t.prototype.value=function(t,n,e){return null==e&&(e=this.obj),this.event(n,e),t},t.prototype.prop=function(t,n){if(null==n&&(n=this.obj),"string"!=typeof t)throw new Error("Property name must be a string");return this.checkEmitter(n)?(this.addEventBind(t+"Invalidated",n,this.getUnknownCallback(t,n)),this.value(n[t],t+"Updated",n)):n[t]},t.prototype.propInitiated=function(t,n){var e;return null==n&&(n=this.obj),e=n.getPropertyInstance(t).initiated,!e&&this.checkEmitter(n)&&this.event(t+"Updated",n),e},t.prototype.validateUnknowns=function(t,n){var e;return null==n&&(n=this.obj),e=this.unknowns,this.unknowns=[],e.forEach(function(t){return t.target[t.prop]})},t.prototype.isEmpty=function(){return 0===this.invalidationEvents.length},t.prototype.bind=function(){return this.invalidationEvents.forEach(function(t){return t.bind()})},t.prototype.recycle=function(t){var n,e;return this.recycled=this.invalidationEvents,this.invalidationEvents=[],n=function(t){return function(){return t.recycled.forEach(function(t){return t.unbind()}),t.recycled=[]}}(this),"function"==typeof t?t.length>1?t(this,n):(e=t(this),n(),e):n},t.prototype.checkEmitter=function(t){return e.checkEmitter(t,this.strict)},t.prototype.unbind=function(){return this.invalidationEvents.forEach(function(t){return t.unbind()})},t}()}),function(n){t.PropertyInstance=n(),t.PropertyInstance.definition=n}(function(e){var i;return null==e&&(e={}),i=e.hasOwnProperty("Invalidator")?e.Invalidator:t.Invalidator,function(){function t(t,n){this.property=t,this.obj=n,this.init()}return t.prototype.init=function(){return this.value=this.ingest(this.property.options.default),this.calculated=!1,this.initiated=void 0!==this.property.options.default,this.revalidateCallback=function(t){return function(){return t.get()}}(this)},t.prototype.get=function(){var t,n;return!1===this.property.options.get?void 0:"function"==typeof this.property.options.get?this.callOptionFunct("get"):(this.invalidator&&this.invalidator.validateUnknowns(),this.isActive()?(this.calculated||(n=this.value,t=this.initiated,this.calcul(),this.value!==n&&(t?this.changed(n):"function"==typeof this.obj.emitEvent&&this.obj.emitEvent(this.property.getUpdateEventName(),[n]))),this.pendingChanges&&this.changed(this.pendingOld),this.output()):void(this.initiated=!0))},t.prototype.set=function(t){var n;return!1===this.property.options.set||("function"==typeof this.property.options.set?this.callOptionFunct("set",t):(t=this.ingest(t),this.revalidated(),this.value!==t&&(n=this.value,this.value=t,this.changed(n)))),this},t.prototype.invalidate=function(){return(this.calculated||!1===this.active)&&(this.calculated=!1,this._invalidateNotice()&&null!=this.invalidator&&this.invalidator.unbind()),this},t.prototype.unknown=function(){return(this.calculated||!1===this.active)&&this._invalidateNotice(),this},t.prototype._invalidateNotice=function(){return this.isImmediate()?(this.get(),!1):("function"==typeof this.obj.emitEvent&&this.obj.emitEvent(this.property.getInvalidateEventName()),null!=this.getUpdater()&&this.getUpdater().bind(),!0)},t.prototype.destroy=function(){if(null!=this.invalidator)return this.invalidator.unbind()},t.prototype.callOptionFunct=function(){var t,e;return e=arguments[0],t=2<=arguments.length?n.call(arguments,1):[],"string"==typeof e&&(e=this.property.options[e]),"function"==typeof e.overrided&&t.push(function(t){return function(){var i;return i=1<=arguments.length?n.call(arguments,0):[],t.callOptionFunct.apply(t,[e.overrided].concat(n.call(i)))}}(this)),e.apply(this.obj,t)},t.prototype.isActive=function(){var t;return"boolean"==typeof this.property.options.active?this.property.options.active:"function"!=typeof this.property.options.active||(t=this.activeInvalidator||new i(this,this.obj),t.recycle(function(t){return function(n,e){return t.active=t.callOptionFunct("active",n),e(),t.active||n.isEmpty()?(n.unbind(),t.activeInvalidator=null):(t.invalidator=n,t.activeInvalidator=n,n.bind())}}(this)),this.active)},t.prototype.calcul=function(){return"function"==typeof this.property.options.calcul&&(this.invalidator||(this.invalidator=new i(this,this.obj)),this.invalidator.recycle(function(t){return function(n,e){return t.value=t.callOptionFunct("calcul",n),e(),n.isEmpty()?t.invalidator=null:n.bind()}}(this))),this.revalidated(),this.value},t.prototype.revalidated=function(){if(this.calculated=!0,this.initiated=!0,null!=this.getUpdater())return this.getUpdater().unbind()},t.prototype.getUpdater=function(){return void 0===this.updater&&(null!=this.property.options.updater?(this.updater=this.property.options.updater,"function"==typeof this.updater.getBinder&&(this.updater=this.updater.getBinder()),"function"!=typeof this.updater.bind||"function"!=typeof this.updater.unbind?this.updater=null:this.updater.callback=this.revalidateCallback):this.updater=null),this.updater},t.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest?t=this.callOptionFunct("ingest",t):t},t.prototype.output=function(){return"function"==typeof this.property.options.output?this.callOptionFunct("output",this.value):this.value},t.prototype.changed=function(t){return this.isActive()?(this.pendingChanges=!1,this.pendingOld=void 0,"function"==typeof this.property.options.change&&this.callOptionFunct("change",t),"function"==typeof this.obj.emitEvent&&(this.obj.emitEvent(this.property.getUpdateEventName(),[t]),this.obj.emitEvent(this.property.getChangeEventName(),[t]))):(this.pendingChanges=!0,void 0===this.pendingOld&&(this.pendingOld=t)),this},t.prototype.isImmediate=function(){return!1!==this.property.options.immediate&&(!0===this.property.options.immediate||("function"==typeof this.property.options.immediate?this.callOptionFunct("immediate"):null==this.getUpdater()&&("function"==typeof this.obj.getListeners&&this.obj.getListeners(this.property.getChangeEventName()).length>0||"function"==typeof this.property.options.change)))},t.bind=function(t,n){var e;return e=n.name.charAt(0).toUpperCase()+n.name.slice(1),Object.defineProperty(t,n.name,{configurable:!0,get:function(){return n.getInstance(this).get()},set:function(t){return n.getInstance(this).set(t)}}),t["get"+e]=function(){return n.getInstance(this).get()},t["set"+e]=function(t){return n.getInstance(this).set(t),this},t["invalidate"+e]=function(){return n.getInstance(this).invalidate(),this}},t}()}),function(n){t.CollectionProperty=n(),t.CollectionProperty.definition=n}(function(n){var i,r;return null==n&&(n={}),r=n.hasOwnProperty("PropertyInstance")?n.PropertyInstance:t.PropertyInstance,i=n.hasOwnProperty("Collection")?n.Collection:t.Collection,function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest&&(t=this.callOptionFunct("ingest",t)),null==t?[]:"function"==typeof t.toArray?t.toArray():Array.isArray(t)?t.slice():[t]},n.prototype.output=function(){var t,n,e;return e=this.value,"function"==typeof this.property.options.output&&(e=this.callOptionFunct("output",this.value)),n=this,t=i.newSubClass(this.property.options.collection,e),t.changed=function(t){return n.changed(t)},t},n}(r)}),function(n){t.ComposedProperty=n(),t.ComposedProperty.definition=n}(function(n){var i,r,o,s;return null==n&&(n={}),s=n.hasOwnProperty("PropertyInstance")?n.PropertyInstance:t.PropertyInstance,o=n.hasOwnProperty("Invalidator")?n.Invalidator:t.Invalidator,i=n.hasOwnProperty("Collection")?n.Collection:t.Collection,r=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.init=function(){return n.__super__.init.call(this),this.property.options.hasOwnProperty("default")?this.default=this.property.options.default:this.default=this.value=!0,this.members=new n.Members(this.property.options.members),this.members.changed=function(t){return function(n){return t.invalidate()}}(this),this.join="function"==typeof this.property.options.composed?this.property.options.composed:!1===this.property.options.default?n.joinFunctions.or:n.joinFunctions.and},n.prototype.calcul=function(){return this.invalidator||(this.invalidator=new o(this,this.obj)),this.invalidator.recycle(function(t){return function(n,e){return t.value=t.members.reduce(function(n,e){var i;return i="function"==typeof e?e(t.invalidator):e,t.join(n,i)},t.default),e(),n.isEmpty()?t.invalidator=null:n.bind()}}(this)),this.revalidated(),this.value},n.bind=function(t,n){return s.bind(t,n),Object.defineProperty(t,n.name+"Members",{configurable:!0,get:function(){return n.getInstance(this).members}})},n.joinFunctions={and:function(t,n){return t&&n},or:function(t,n){return t||n}},n}(s),r.Members=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.addPropertyRef=function(t,n){var e;if(-1===this.findRefIndex(t,n))return e=function(e){return e.prop(t,n)},e.ref={name:t,obj:n},this.push(e)},n.prototype.addValueRef=function(t,n,e){var i;if(-1===this.findRefIndex(n,e))return i=function(n){return t},i.ref={name:n,obj:e},this.push(i)},n.prototype.addFunctionRef=function(t,n,e){if(-1===this.findRefIndex(n,e))return t.ref={name:n,obj:e},this.push(t)},n.prototype.findRefIndex=function(t,n){return this._array.findIndex(function(e){return null!=e.ref&&e.ref.obj===n&&e.ref.name===t})},n.prototype.removeRef=function(t,n){var e,i;if(-1!==(e=this.findRefIndex(t,n)))return i=this.toArray(),this._array.splice(e,1),this.changed(i)},n}(i),r}),function(n){t.Property=n(),t.Property.definition=n}(function(n){var e,i,r;return null==n&&(n={}),r=n.hasOwnProperty("PropertyInstance")?n.PropertyInstance:t.PropertyInstance,e=n.hasOwnProperty("CollectionProperty")?n.CollectionProperty:t.CollectionProperty,i=n.hasOwnProperty("ComposedProperty")?n.ComposedProperty:t.ComposedProperty,function(){function t(t,n){this.name=t,this.options=null!=n?n:{}}return t.prototype.bind=function(t){var n,e;return e=this,"function"==typeof t.getProperty&&t.getProperty(this.name)===this||("function"==typeof t.getProperty&&null!=(n=t.getProperty(this.name))&&this.override(n),this.getInstanceType().bind(t,e),t._properties=(t._properties||[]).concat([e]),null!=n&&(t._properties=t._properties.filter(function(t){return t!==n})),this.checkFunctions(t),this.checkAfterAddListener(t)),e},t.prototype.override=function(t){var n,e,i,r;if(null==this.options.parent){this.options.parent=t.options,e=t.options,i=[];for(n in e)r=e[n],"function"==typeof this.options[n]&&"function"==typeof r?i.push(this.options[n].overrided=r):void 0===this.options[n]?i.push(this.options[n]=r):i.push(void 0);return i}},t.prototype.checkFunctions=function(n){var e,i,r,o;this.checkAfterAddListener(n),r=t.fn,o=[];for(i in r)e=r[i],void 0===n[i]?o.push(n[i]=e):o.push(void 0);return o},t.prototype.checkAfterAddListener=function(n){var e;if("function"==typeof n.addListener&&void 0===n.afterAddListener&&void 0===n.addListener.overrided)return n.afterAddListener=t.optionalFn.afterAddListener,e=n.addListener,n.addListener=function(t,n){return this.addListener.overrided.call(this,t,n),this.afterAddListener(t)},n.addListener.overrided=e},t.prototype.getInstanceVarName=function(){return this.options.instanceVarName||"_"+this.name},t.prototype.isInstantiated=function(t){return null!=t[this.getInstanceVarName()]},t.prototype.getInstance=function(t){var n,e;return e=this.getInstanceVarName(),this.isInstantiated(t)||(n=this.getInstanceType(),t[e]=new n(this,t)),t[e]},t.prototype.getInstanceType=function(){return null!=this.options.composed?i:null!=this.options.collection?e:r},t.prototype.getChangeEventName=function(){return this.options.changeEventName||this.name+"Changed"},t.prototype.getUpdateEventName=function(){return this.options.changeEventName||this.name+"Updated"},t.prototype.getInvalidateEventName=function(){return this.options.changeEventName||this.name+"Invalidated"},t.fn={getProperty:function(t){return this._properties.find(function(n){return n.name===t})},getPropertyInstance:function(t){var n;if(n=this.getProperty(t))return n.getInstance(this)},getProperties:function(){return this._properties.slice()},getPropertyInstances:function(){return this._properties.map(function(t){return function(n){return n.getInstance(t)}}(this))},getInstantiatedProperties:function(){return this._properties.filter(function(t){return function(n){return n.isInstantiated(t)}}(this)).map(function(t){return function(n){return n.getInstance(t)}}(this))},setProperties:function(t,n){var e,i,r;null==n&&(n={});for(e in t)r=t[e],null!=n.whitelist&&-1===n.whitelist.indexOf(e)||null!=n.blacklist&&-1!==n.blacklist.indexOf(e)||null!=(i=this.getPropertyInstance(e))&&i.set(r);return this},destroyProperties:function(){return this.getInstantiatedProperties().forEach(function(t){return function(t){return t.destroy()}}()),this._properties=[],!0}},t.optionalFn={afterAddListener:function(t){return this._properties.forEach(function(n){return function(e){if(e.getChangeEventName()===t)return e.getInstance(n).get()}}(this))}},t}()}),function(n){t.Element=n(),t.Element.definition=n}(function(e){var i;return null==e&&(e={}),i=e.hasOwnProperty("Property")?e.Property:t.Property,function(){function t(){}return t.elementKeywords=["extended","included","__super__","constructor"],t.prototype.tap=function(t){var n;return n=Array.prototype.slice.call(arguments),"function"==typeof t?t.apply(this,n.slice(1)):this[t].apply(this,n.slice(1)),this},t.prototype.callback=function(t){return null==this._callbacks&&(this._callbacks={}),null!=this._callbacks[t]?this._callbacks[t]:this._callbacks[t]=function(e){return function(){var i;return i=1<=arguments.length?n.call(arguments,0):[],e[t].apply(e,i),null}}(this)},t.extend=function(n){var e,i,o;for(e in n)o=n[e],r.call(t.elementKeywords,e)<0&&(this[e]=o);return null!=n.prototype&&this.include(n.prototype),null!=(i=n.extended)&&i.apply(this),this},t.include=function(n){var e,i,o,s,a,u;for(i in n)if(u=n[i],r.call(t.elementKeywords,i)<0)if("_properties"===i)for(e=0,o=u.length;e<o;e++)s=u[e],s.bind(this.prototype);else this.prototype[i]=u;return null!=(a=n.included)&&a.apply(this),this},t.property=function(t,n){return new i(t,n).bind(this.prototype)},t.properties=function(t){var n,e,i;i=[];for(e in t)n=t[e],i.push(this.property(e,n));return i},t}()}),function(n){t.Updater=n(),t.Updater.definition=n}(function(){var t;return t=function(){function t(){this.callbacks=[],this.next=[],this.updating=!1}return t.prototype.update=function(){for(this.updating=!0,this.next=this.callbacks.slice();this.callbacks.length>0;)this.callbacks.shift()();return this.callbacks=this.next,this.updating=!1,this},t.prototype.addCallback=function(t){if(this.callbacks.includes(t)||this.callbacks.push(t),this.updating&&!this.next.includes(t))return this.next.push(t)},t.prototype.nextTick=function(t){return this.updating?this.next.includes(t)?void 0:this.next.push(t):this.addCallback(t)},t.prototype.removeCallback=function(t){var n;if(n=this.callbacks.indexOf(t),-1!==n&&this.callbacks.splice(n,1),-1!==(n=this.next.indexOf(t)))return this.next.splice(n,1)},t.prototype.getBinder=function(){return new t.Binder(this)},t}(),t.Binder=function(){function t(t){this.target=t,this.binded=!1}return t.prototype.bind=function(){return this.binded||null==this.callback||this.target.addCallback(this.callback),this.binded=!0},t.prototype.unbind=function(){return this.binded&&null!=this.callback&&this.target.removeCallback(this.callback),this.binded=!1},t}(),t})}).call(this);