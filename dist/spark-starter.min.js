(function(){var o,t,n,e,i,r,a,s,u,p,c,l,h,d,f=[].slice,y=function(t,n){for(var e in n)v.call(n,e)&&(t[e]=n[e]);function i(){this.constructor=t}return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},v={}.hasOwnProperty,g=[].indexOf||function(t){for(var n=0,e=this.length;n<e;n++)if(n in this&&this[n]===t)return n;return-1};o="undefined"!=typeof module&&null!==module?module.exports={}:(null==this.Spark&&(this.Spark={}),this.Spark),t=function(){return function(){function e(t,n){this.property=t,this.obj=n,this.init()}return e.prototype.init=function(){return this.value=this.ingest(this.default),this.calculated=!1},e.prototype.get=function(){return this.calculated=!0,this.output()},e.prototype.set=function(t){return this.setAndCheckChanges(t)},e.prototype.callbackSet=function(t){return this.callOptionFunct("set",t),this},e.prototype.setAndCheckChanges=function(t){var n;return t=this.ingest(t),this.revalidated(),this.checkChanges(t,this.value)&&(n=this.value,this.value=t,this.manual=!0,this.changed(n)),this},e.prototype.checkChanges=function(t,n){return t!==n},e.prototype.destroy=function(){},e.prototype.callOptionFunct=function(){var t,n,e;return n=arguments[0],t=2<=arguments.length?f.call(arguments,1):[],"string"==typeof n&&(n=this.property.options[n]),"function"==typeof n.overrided&&t.push((e=this,function(){var t;return t=1<=arguments.length?f.call(arguments,0):[],e.callOptionFunct.apply(e,[n.overrided].concat(f.call(t)))})),n.apply(this.obj,t)},e.prototype.revalidated=function(){return this.calculated=!0,this.initiated=!0},e.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest?this.callOptionFunct("ingest",t):t},e.prototype.output=function(){return"function"==typeof this.property.options.output?this.callOptionFunct("output",this.value):this.value},e.prototype.changed=function(t){return this.callChangedFunctions(t),"function"==typeof this.obj.emitEvent&&(this.obj.emitEvent(this.updateEventName,[t]),this.obj.emitEvent(this.changeEventName,[t])),this},e.prototype.callChangedFunctions=function(t){if("function"==typeof this.property.options.change)return this.callOptionFunct("change",t)},e.prototype.hasChangedFunctions=function(){return"function"==typeof this.property.options.change},e.prototype.hasChangedEvents=function(){return"function"==typeof this.obj.getListeners&&0<this.obj.getListeners(this.changeEventName).length},e.compose=function(t){return null==t.instanceType&&(t.instanceType=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,e),n}()),"function"==typeof t.options.set?t.instanceType.prototype.set=this.prototype.callbackSet:t.instanceType.prototype.set=this.prototype.setAndCheckChanges,t.instanceType.prototype.default=t.options.default,t.instanceType.prototype.initiated=void 0!==t.options.default,this.setEventNames(t)},e.setEventNames=function(t){return t.instanceType.prototype.changeEventName=t.options.changeEventName||t.name+"Changed",t.instanceType.prototype.updateEventName=t.options.updateEventName||t.name+"Updated",t.instanceType.prototype.invalidateEventName=t.options.invalidateEventName||t.name+"Invalidated"},e.bind=function(t,n){var e,i;return e=n.name.charAt(0).toUpperCase()+n.name.slice(1),!(i={configurable:!0,get:function(){return n.getInstance(this).get()}})!==n.options.set&&(i.set=function(t){return n.getInstance(this).set(t)}),Object.defineProperty(t,n.name,i),!(t["get"+e]=function(){return n.getInstance(this).get()})!==n.options.set&&(t["set"+e]=function(t){return n.getInstance(this).set(t),this}),t["invalidate"+e]=function(){return n.getInstance(this).invalidate(),this}},e}()},o.PropertyInstance=t(),o.PropertyInstance.definition=t,n=function(){return function(){function t(){}return t.prototype.bind=function(){return this.binded||null==this.callback||null==this.target||this.doBind(),this.binded=!0},t.prototype.doBind=function(){throw new Error("Not implemented")},t.prototype.unbind=function(){return this.binded&&null!=this.callback&&null!=this.target&&this.doUnbind(),this.binded=!1},t.prototype.doUnbind=function(){throw new Error("Not implemented")},t.prototype.equals=function(t){return this.constructor.compareRefered(t,this)},t.compareRefered=function(t,n){return t===n||null!=t&&null!=n&&t.constructor===n.constructor&&this.compareRef(t.ref,n.ref)},t.compareRef=function(e,i){return null!=e&&null!=i&&(e===i||Array.isArray(e)&&Array.isArray(e)&&e.every((r=this,function(t,n){return r.compareRefered(e[n],i[n])}))||"object"==typeof e&&"object"==typeof i&&Object.keys(e).join()===Object.keys(i).join()&&Object.keys(e).every((n=this,function(t){return n.compareRefered(e[t],i[t])})));var n,r},t}()},o.Binder=n(),o.Binder.definition=n,e=function(t){var e;return null==t&&(t={}),e=t.hasOwnProperty("Binder")?t.Binder:o.Binder,function(t){function n(t,n,e){this.event=t,this.target=n,this.callback=e,this.ref={event:this.event,target:this.target,callback:this.callback}}return y(n,e),n.prototype.doBind=function(){if("function"==typeof this.target.addEventListener)return this.target.addEventListener(this.event,this.callback);if("function"==typeof this.target.addListener)return this.target.addListener(this.event,this.callback);if("function"==typeof this.target.on)return this.target.on(this.event,this.callback);throw new Error("No function to add event listeners was found")},n.prototype.doUnbind=function(){if("function"==typeof this.target.removeEventListener)return this.target.removeEventListener(this.event,this.callback);if("function"==typeof this.target.removeListener)return this.target.removeListener(this.event,this.callback);if("function"==typeof this.target.off)return this.target.off(this.event,this.callback);throw new Error("No function to remove event listeners was found")},n.prototype.equals=function(t){return n.__super__.equals.call(this,t)&&t.event===this.event},n.prototype.match=function(t,n){return t===this.event&&n===this.target},n.checkEmitter=function(t,n){if(null==n&&(n=!0),"function"==typeof t.addEventListener||"function"==typeof t.addListener||"function"==typeof t.on)return!0;if(n)throw new Error("No function to add event listeners was found");return!1},n}()},o.EventBind=e(),o.EventBind.definition=e,i=function(t){var n,i,e;return null==t&&(t={}),n=t.hasOwnProperty("Binder")?t.Binder:o.Binder,i=t.hasOwnProperty("EventBind")?t.EventBind:o.EventBind,e=function(t,n){var e,i;return-1<(i=t.findIndex(n))?(e=t[i],t.splice(i,1),e):null},function(t){function o(t,n){var e;this.property=t,this.obj=null!=n?n:null,this.invalidationEvents=[],this.recycled=[],this.unknowns=[],this.strict=this.constructor.strict,this.invalidated=!1,this.invalidateCallback=(e=this,function(){return e.invalidate(),null})}return y(o,n),o.strict=!0,o.prototype.invalidate=function(){var t;return this.invalidated=!0,"function"==typeof this.property?this.property():"function"==typeof this.callback?this.callback():null!=this.property&&"function"==typeof this.property.invalidate?this.property.invalidate():"string"==typeof this.property?(t="invalidate"+this.property.charAt(0).toUpperCase()+this.property.slice(1),"function"==typeof this.obj[t]?this.obj[t]():this.obj[this.property]=null):void 0},o.prototype.unknown=function(){return"function"==typeof this.property.unknown?this.property.unknown():this.invalidate()},o.prototype.addEventBind=function(t,n,e){return this.addBinder(new i(t,n,e))},o.prototype.addBinder=function(n){if(null==n.callback&&(n.callback=this.invalidateCallback),!this.invalidationEvents.some(function(t){return t.equals(n)}))return this.invalidationEvents.push(e(this.recycled,function(t){return t.equals(n)})||n)},o.prototype.getUnknownCallback=function(t,n){var e,i;return i=this,(e=function(){return i.addUnknown(function(){return n[t]},t,n)}).ref={maker:arguments.callee,prop:t,target:n},e},o.prototype.addUnknown=function(t,n,e){if(!this.findUnknown(n,e))return t.ref={prop:n,target:e},this.unknowns.push(t),this.unknown()},o.prototype.findUnknown=function(n,e){if(null!=n||null!=e)return this.unknowns.find(function(t){return t.ref.prop===n&&t.ref.target===e})},o.prototype.event=function(t,n){if(null==n&&(n=this.obj),this.checkEmitter(n))return this.addEventBind(t,n)},o.prototype.value=function(t,n,e){return null==e&&(e=this.obj),this.event(n,e),t},o.prototype.prop=function(t,n){if(null==n&&(n=this.obj),"string"!=typeof t)throw new Error("Property name must be a string");return this.checkEmitter(n)?(this.addEventBind(t+"Invalidated",n,this.getUnknownCallback(t,n)),this.value(n[t],t+"Updated",n)):n[t]},o.prototype.propInitiated=function(t,n){var e;return null==n&&(n=this.obj),!(e=n.getPropertyInstance(t).initiated)&&this.checkEmitter(n)&&this.event(t+"Updated",n),e},o.prototype.funct=function(n){var e,i,r;return e=new o((r=this,function(){return r.addUnknown(function(){var t;if(t=n(e),i!==t)return r.invalidate()},e)})),i=n(e),this.invalidationEvents.push(e),i},o.prototype.validateUnknowns=function(t,n){var e;return null==n&&(n=this.obj),e=this.unknowns,this.unknowns=[],e.forEach(function(t){return t()})},o.prototype.isEmpty=function(){return 0===this.invalidationEvents.length},o.prototype.bind=function(){return this.invalidated=!1,this.invalidationEvents.forEach(function(t){return t.bind()})},o.prototype.recycle=function(t){var n,e,i;return this.recycled=this.invalidationEvents,this.invalidationEvents=[],i=this,n=function(){return i.recycled.forEach(function(t){return t.unbind()}),i.recycled=[]},"function"==typeof t?1<t.length?t(this,n):(e=t(this),n(),e):n},o.prototype.checkEmitter=function(t){return i.checkEmitter(t,this.strict)},o.prototype.unbind=function(){return this.invalidationEvents.forEach(function(t){return t.unbind()})},o}()},o.Invalidator=i(),o.Invalidator.definition=i,r=function(t){var i,e;return null==t&&(t={}),i=t.hasOwnProperty("Invalidator")?t.Invalidator:o.Invalidator,e=t.hasOwnProperty("PropertyInstance")?t.PropertyInstance:o.PropertyInstance,function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,e),n.prototype.activableGet=function(){return this.get()},n.prototype.activableGet=function(){var t;return this.isActive()?(t=this.activeGet(),this.pendingChanges&&this.changed(this.pendingOld),t):void(this.initiated=!0)},n.prototype.isActive=function(){return!0},n.prototype.manualActive=function(){return this.active},n.prototype.callbackActive=function(){var e;return(this.activeInvalidator||new i(this,this.obj)).recycle((e=this,function(t,n){return e.active=e.callOptionFunct(e.activeFunct,t),n(),e.active||t.isEmpty()?(t.unbind(),e.activeInvalidator=null):(e.invalidator=t,(e.activeInvalidator=t).bind())})),this.active},n.prototype.activeChanged=function(t){return this.changed(t)},n.prototype.activableChanged=function(t){return this.isActive()?(this.pendingChanges=!1,this.pendingOld=void 0,this.activeChanged()):(this.pendingChanges=!0,void 0===this.pendingOld&&(this.pendingOld=t)),this},n.compose=function(t){if(void 0!==t.options.active){if(t.instanceType.prototype.activeGet=t.instanceType.prototype.get,t.instanceType.prototype.get=this.prototype.activableGet,t.instanceType.prototype.activeChanged=t.instanceType.prototype.changed,t.instanceType.prototype.changed=this.prototype.activableChanged,"boolean"==typeof t.options.active)return t.instanceType.prototype.active=t.options.active,t.instanceType.prototype.isActive=this.prototype.manualActive;if("function"==typeof t.options.active)return t.instanceType.prototype.activeFunct=t.options.active,t.instanceType.prototype.isActive=this.prototype.callbackActive}},n}()},o.ActivableProperty=r(),o.ActivableProperty.definition=r,a=function(t){var n;return null==t&&(t={}),t.hasOwnProperty("Invalidator")?t.Invalidator:o.Invalidator,n=t.hasOwnProperty("PropertyInstance")?t.PropertyInstance:o.PropertyInstance,function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,n),e.prototype.init=function(){return e.__super__.init.call(this),this.initRevalidate()},e.prototype.initRevalidate=function(){return this.revalidateCallback=(t=this,function(){return t.get()});var t},e.prototype.callbackGet=function(){var t;return t=this.callOptionFunct("get"),this.revalidated(),t},e.prototype.invalidate=function(){return(this.calculated||!1===this.active)&&(this.calculated=!1,this._invalidateNotice()),this},e.prototype.revalidate=function(){return e.__super__.revalidate.call(this),this.revalidateUpdater()},e.prototype.revalidateUpdater=function(){if(null!=this.getUpdater())return this.getUpdater().unbind()},e.prototype._invalidateNotice=function(){return this.isImmediate()?(this.get(),!1):("function"==typeof this.obj.emitEvent&&this.obj.emitEvent(this.invalidateEventName),null!=this.getUpdater()&&this.getUpdater().bind(),!0)},e.prototype.getUpdater=function(){return void 0===this.updater&&(null!=this.property.options.updater?(this.updater=this.property.options.updater,"function"==typeof this.updater.getBinder&&(this.updater=this.updater.getBinder()),"function"!=typeof this.updater.bind||"function"!=typeof this.updater.unbind?this.updater=null:this.updater.callback=this.revalidateCallback):this.updater=null),this.updater},e.prototype.isImmediate=function(){return!1!==this.property.options.immediate&&(!0===this.property.options.immediate||("function"==typeof this.property.options.immediate?this.callOptionFunct("immediate"):null==this.getUpdater()&&(this.hasChangedEvents()||this.hasChangedFunctions())))},e.compose=function(t){if("function"!=typeof t.options.get&&"function"!=typeof t.options.calcul&&"function"!=typeof t.options.active||null==t.instanceType&&(t.instanceType=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,e),n}()),"function"==typeof t.options.get)return t.instanceType.prototype.get=this.prototype.callbackGet},e}()},o.DynamicProperty=a(),o.DynamicProperty.definition=a,s=function(t){var e,i;return null==t&&(t={}),i=t.hasOwnProperty("Invalidator")?t.Invalidator:o.Invalidator,e=t.hasOwnProperty("DynamicProperty")?t.DynamicProperty:o.DynamicProperty,function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,e),n.prototype.calculatedGet=function(){var t,n;return this.invalidator&&this.invalidator.validateUnknowns(),this.calculated||(n=this.value,t=this.initiated,this.calcul(),this.checkChanges(this.value,n)&&(t?this.changed(n):"function"==typeof this.obj.emitEvent&&this.obj.emitEvent(this.updateEventName,[n]))),this.output()},n.prototype.calcul=function(){return this.revalidated(),this.value},n.prototype.callbackCalcul=function(){return this.value=this.callOptionFunct(this.calculFunct),this.manual=!1,this.revalidated(),this.value},n.prototype.invalidatedCalcul=function(){var e;return this.invalidator||(this.invalidator=new i(this,this.obj)),this.invalidator.recycle((e=this,function(t,n){return e.value=e.callOptionFunct(e.calculFunct,t),e.manual=!1,n(),t.isEmpty()?e.invalidator=null:t.bind()})),this.revalidated(),this.value},n.prototype.unknown=function(){return(this.calculated||!1===this.active)&&this._invalidateNotice(),this},n.prototype.destroyWhithoutInvalidator=function(){return this.destroy()},n.prototype.destroyInvalidator=function(){if(this.destroyWhithoutInvalidator(),null!=this.invalidator)return this.invalidator.unbind()},n.prototype.invalidateInvalidator=function(){return(this.calculated||!1===this.active)&&(this.calculated=!1,this._invalidateNotice()&&null!=this.invalidator&&this.invalidator.unbind()),this},n.compose=function(t){if("function"==typeof t.options.calcul)return t.instanceType.prototype.calculFunct=t.options.calcul,t.instanceType.prototype.get=this.prototype.calculatedGet,0<t.options.calcul.length?(t.instanceType.prototype.calcul=this.prototype.invalidatedCalcul,t.instanceType.prototype.destroyWhithoutInvalidator=t.instanceType.prototype.destroy,t.instanceType.prototype.destroy=this.prototype.destroyInvalidator,t.instanceType.prototype.invalidate=this.prototype.invalidateInvalidator,t.instanceType.prototype.unknown=this.prototype.unknown):t.instanceType.prototype.calcul=this.prototype.callbackCalcul},n}()},o.CalculatedProperty=s(),o.CalculatedProperty.definition=s,u=function(){var t;return t=function(){function t(t){null!=t?"function"==typeof t.toArray?this._array=t.toArray():Array.isArray(t)?this._array=t:this._array=[t]:this._array=[]}return t.prototype.changed=function(){},t.prototype.checkChanges=function(e,t,i){return null==t&&(t=!0),null==i&&(i=null),null==i&&(i=function(t,n){return t===n}),e=this.copy(e),this.count()!==e.length||(t?this.some(function(t,n){return!i(e.get(n),t)}):this.some(function(n){return!e.pluck(function(t){return i(n,t)})}))},t.prototype.get=function(t){return this._array[t]},t.prototype.set=function(t,n){var e;return this._array[t]!==n&&(e=this.toArray(),this._array[t]=n,this.changed(e)),n},t.prototype.add=function(t){if(!this._array.includes(t))return this.push(t)},t.prototype.remove=function(t){var n,e;if(-1!==(n=this._array.indexOf(t)))return e=this.toArray(),this._array.splice(n,1),this.changed(e)},t.prototype.pluck=function(t){var n,e,i;return-1<(e=this._array.findIndex(t))?(i=this.toArray(),n=this._array[e],this._array.splice(e,1),this.changed(i),n):null},t.prototype.toArray=function(){return this._array.slice()},t.prototype.count=function(){return this._array.length},t.readFunctions=["every","find","findIndex","forEach","includes","indexOf","join","lastIndexOf","map","reduce","reduceRight","some","toString"],t.readListFunctions=["concat","filter","slice"],t.writefunctions=["pop","push","reverse","shift","sort","splice","unshift"],t.readFunctions.forEach(function(e){return t.prototype[e]=function(){var t,n;return t=1<=arguments.length?f.call(arguments,0):[],(n=this._array)[e].apply(n,t)}}),t.readListFunctions.forEach(function(e){return t.prototype[e]=function(){var t,n;return t=1<=arguments.length?f.call(arguments,0):[],this.copy((n=this._array)[e].apply(n,t))}}),t.writefunctions.forEach(function(r){return t.prototype[r]=function(){var t,n,e,i;return t=1<=arguments.length?f.call(arguments,0):[],n=this.toArray(),i=(e=this._array)[r].apply(e,t),this.changed(n),i}}),t.newSubClass=function(t,n){var e;return"object"==typeof t?(e=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,t),n}(this),Object.assign(e.prototype,t),new e(n)):new this(n)},t.prototype.copy=function(t){return null==t&&(t=this.toArray()),new this.constructor(t)},t.prototype.equals=function(e){return this.count()===("function"==typeof e.count?e.count():e.length)&&this.every(function(t,n){return e[n]===t})},t.prototype.getAddedFrom=function(n){return this._array.filter(function(t){return!n.includes(t)})},t.prototype.getRemovedFrom=function(t){return t.filter((n=this,function(t){return!n.includes(t)}));var n},t}(),Object.defineProperty(t.prototype,"length",{get:function(){return this.count()}}),("undefined"!=typeof Symbol&&null!==Symbol?Symbol.iterator:void 0)&&(t.prototype[Symbol.iterator]=function(){return this._array[Symbol.iterator]()}),t},o.Collection=u(),o.Collection.definition=u,p=function(t){var i,n;return null==t&&(t={}),n=t.hasOwnProperty("DynamicProperty")?t.DynamicProperty:o.DynamicProperty,i=t.hasOwnProperty("Collection")?t.Collection:o.Collection,function(t){function o(){return o.__super__.constructor.apply(this,arguments)}return y(o,n),o.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest&&(t=this.callOptionFunct("ingest",t)),null==t?[]:"function"==typeof t.toArray?t.toArray():Array.isArray(t)?t.slice():[t]},o.prototype.output=function(){var t,n,e;return e=this.value,"function"==typeof this.property.options.output&&(e=this.callOptionFunct("output",this.value)),n=this,(t=i.newSubClass(this.property.options.collection,e)).changed=function(t){return n.changed(t)},t},o.prototype.callChangedFunctions=function(e){var i,r;return"function"==typeof this.property.options.itemAdded&&this.value.forEach((i=this,function(t,n){if(!e.includes(t))return i.callOptionFunct("itemAdded",t,n)})),"function"==typeof this.property.options.itemRemoved&&e.forEach((r=this,function(t,n){if(!r.value.includes(t))return r.callOptionFunct("itemRemoved",t,n)})),o.__super__.callChangedFunctions.call(this,e)},o.prototype.hasChangedFunctions=function(){return o.__super__.hasChangedFunctions.call(this)||"function"==typeof this.property.options.itemAdded||"function"==typeof this.property.options.itemRemoved},o.compose=function(t){if(null!=t.options.collection)return t.instanceType=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,o),n}()},o}()},o.CollectionProperty=p(),o.CollectionProperty.definition=p,c=function(t){var i,e,n,r;return null==t&&(t={}),i=t.hasOwnProperty("CalculatedProperty")?t.CalculatedProperty:o.CalculatedProperty,r=t.hasOwnProperty("Invalidator")?t.Invalidator:o.Invalidator,e=t.hasOwnProperty("Collection")?t.Collection:o.Collection,(n=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,i),e.prototype.init=function(){return e.__super__.init.call(this),this.initComposed()},e.prototype.initComposed=function(){var n;return this.property.options.hasOwnProperty("default")?this.default=this.property.options.default:this.default=this.value=!0,this.members=new e.Members(this.property.options.members),this.members.changed=(n=this,function(t){return n.invalidate()}),this.join="function"==typeof this.property.options.composed?this.property.options.composed:!1===this.property.options.default?e.joinFunctions.or:e.joinFunctions.and},e.prototype.calcul=function(){var i;return this.invalidator||(this.invalidator=new r(this,this.obj)),this.invalidator.recycle((i=this,function(t,n){return i.value=i.members.reduce(function(t,n){var e;return e="function"==typeof n?n(i.invalidator):n,i.join(t,e)},i.default),n(),t.isEmpty()?i.invalidator=null:t.bind()})),this.revalidated(),this.value},e.compose=function(t){if(null!=t.options.composed)return t.instanceType=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,e),n}(),t.instanceType.prototype.get=this.prototype.calculatedGet},e.bind=function(t,n){return i.bind(t,n),Object.defineProperty(t,n.name+"Members",{configurable:!0,get:function(){return n.getInstance(this).members}})},e.joinFunctions={and:function(t,n){return t&&n},or:function(t,n){return t||n}},e}()).Members=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,e),n.prototype.addPropertyRef=function(n,e){var t;if(-1===this.findRefIndex(n,e))return(t=function(t){return t.prop(n,e)}).ref={name:n,obj:e},this.push(t)},n.prototype.addValueRef=function(n,t,e){var i;if(-1===this.findRefIndex(t,e))return(i=function(t){return n}).ref={name:t,obj:e,val:n},this.push(i)},n.prototype.setValueRef=function(n,t,e){var i,r;return-1===(r=this.findRefIndex(t,e))?this.addValueRef(n,t,e):this.get(r).ref.val!==n?((i=function(t){return n}).ref={name:t,obj:e,val:n},this.set(r,i)):void 0},n.prototype.addFunctionRef=function(t,n,e){if(-1===this.findRefIndex(n,e))return t.ref={name:n,obj:e},this.push(t)},n.prototype.findRefIndex=function(n,e){return this._array.findIndex(function(t){return null!=t.ref&&t.ref.obj===e&&t.ref.name===n})},n.prototype.removeRef=function(t,n){var e,i;if(-1!==(e=this.findRefIndex(t,n)))return i=this.toArray(),this._array.splice(e,1),this.changed(i)},n}(),n},o.ComposedProperty=c(),o.ComposedProperty.definition=c,l=function(t){var n,e,i,r,a,s;return null==t&&(t={}),s=t.hasOwnProperty("PropertyInstance")?t.PropertyInstance:o.PropertyInstance,i=t.hasOwnProperty("CollectionProperty")?t.CollectionProperty:o.CollectionProperty,r=t.hasOwnProperty("ComposedProperty")?t.ComposedProperty:o.ComposedProperty,a=t.hasOwnProperty("DynamicProperty")?t.DynamicProperty:o.DynamicProperty,e=t.hasOwnProperty("CalculatedProperty")?t.CalculatedProperty:o.CalculatedProperty,n=t.hasOwnProperty("ActivableProperty")?t.ActivableProperty:o.ActivableProperty,function(){function o(t,n){this.name=t,this.options=null!=n?n:{}}return o.prototype.composers=[r,i,a,s,e,n],o.prototype.bind=function(t){var n;return this,"function"==typeof t.getProperty&&t.getProperty(this.name)===this||("function"==typeof t.getProperty&&null!=(n=t.getProperty(this.name))&&this.override(n),this.getInstanceType().bind(t,this),t._properties=(t._properties||[]).concat([this]),null!=n&&(t._properties=t._properties.filter(function(t){return t!==n})),this.checkFunctions(t),this.checkAfterAddListener(t)),this},o.prototype.override=function(t){var n,e,i,r;if(null==this.options.parent){for(n in this.options.parent=t.options,i=[],e=t.options)r=e[n],"function"==typeof this.options[n]&&"function"==typeof r?i.push(this.options[n].overrided=r):void 0===this.options[n]?i.push(this.options[n]=r):i.push(void 0);return i}},o.prototype.checkFunctions=function(t){var n,e,i,r;for(e in this.checkAfterAddListener(t),r=[],i=o.fn)n=i[e],void 0===t[e]?r.push(t[e]=n):r.push(void 0);return r},o.prototype.checkAfterAddListener=function(t){var n;if("function"==typeof t.addListener&&void 0===t.afterAddListener&&void 0===t.addListener.overrided)return t.afterAddListener=o.optionalFn.afterAddListener,n=t.addListener,t.addListener=function(t,n){return this.addListener.overrided.call(this,t,n),this.afterAddListener(t)},t.addListener.overrided=n},o.prototype.getInstanceVarName=function(){return this.options.instanceVarName||"_"+this.name},o.prototype.isInstantiated=function(t){return null!=t[this.getInstanceVarName()]},o.prototype.getInstance=function(t){var n,e;return e=this.getInstanceVarName(),this.isInstantiated(t)||(n=this.getInstanceType(),t[e]=new n(this,t)),t[e]},o.prototype.getInstanceType=function(){var n;return this.instanceType||this.composers.forEach((n=this,function(t){return t.compose(n)})),this.instanceType},o.fn={getProperty:function(n){return this._properties&&this._properties.find(function(t){return t.name===n})},getPropertyInstance:function(t){var n;if(n=this.getProperty(t))return n.getInstance(this)},getProperties:function(){return this._properties.slice()},getPropertyInstances:function(){return this._properties.map((n=this,function(t){return t.getInstance(n)}));var n},getInstantiatedProperties:function(){return this._properties.filter((e=this,function(t){return t.isInstantiated(e)})).map((n=this,function(t){return t.getInstance(n)}));var n,e},getManualDataProperties:function(){return this._properties.reduce((i=this,function(t,n){var e;return n.isInstantiated(i)&&(e=n.getInstance(i)).calculated&&e.manual&&(t[n.name]=e.value),t}),{});var i},setProperties:function(t,n){var e,i,r;for(e in null==n&&(n={}),t)r=t[e],null!=n.whitelist&&-1===n.whitelist.indexOf(e)||null!=n.blacklist&&-1!==n.blacklist.indexOf(e)||null!=(i=this.getPropertyInstance(e))&&i.set(r);return this},destroyProperties:function(){return this.getInstantiatedProperties().forEach(function(t){return t.destroy()}),this._properties=[],!0}},o.optionalFn={afterAddListener:function(n){return this._properties.forEach((e=this,function(t){if(t.getInstanceType().prototype.changeEventName===n)return t.getInstance(e).get()}));var e}},o}()},o.Property=l(),o.Property.definition=l,h=function(t){var e;return null==t&&(t={}),e=t.hasOwnProperty("Property")?t.Property:o.Property,function(){function r(){}return r.elementKeywords=["extended","included","__super__","constructor"],r.prototype.tap=function(t){var n;return n=Array.prototype.slice.call(arguments),"function"==typeof t?t.apply(this,n.slice(1)):this[t].apply(this,n.slice(1)),this},r.prototype.callback=function(n){return null==this._callbacks&&(this._callbacks={}),null!=this._callbacks[n]?this._callbacks[n]:this._callbacks[n]=(e=this,function(){var t;return t=1<=arguments.length?f.call(arguments,0):[],e[n].apply(e,t),null});var e},r.extend=function(t){var n,e,i;for(n in t)i=t[n],g.call(r.elementKeywords,n)<0&&(this[n]=i);return null!=t.prototype&&this.include(t.prototype),null!=(e=t.extended)&&e.apply(this),this},r.getIncludableProperties=function(t){var e,i;for(e=r.elementKeywords,null!=t._properties&&(e=e.concat(t._properties.map(function(t){return t.name}))).push("_properties"),i=[];i=i.concat(Object.getOwnPropertyNames(t).filter(function(n){return function(t){return!n.prototype.hasOwnProperty(t)&&"__"!==t.substr(0,2)&&g.call(e,t)<0&&g.call(i,t)<0}}(this))),(t=Object.getPrototypeOf(t))&&t!==Object&&t!==r.prototype;);return i},r.include=function(t){var n,e,i,r,o,a,s,u,p;for(n=0,r=(s=this.getIncludableProperties(t)).length;n<r;n++)i=s[n],this.prototype[i]=t[i];if(null!=t._properties)for(e=0,o=(u=t._properties).length;e<o;e++)a=u[e],this.property(a.name,Object.assign({},a.options));return null!=(p=t.included)&&p.apply(this),this},r.property=function(t,n){return new e(t,n).bind(this.prototype)},r.properties=function(t){var n,e,i;for(e in i=[],t)n=t[e],i.push(this.property(e,n));return i},r}()},o.Element=h(),o.Element.definition=h,d=function(t){var e,n;return null==t&&(t={}),e=t.hasOwnProperty("Binder")?t.Binder:o.Binder,(n=function(){function t(){this.callbacks=[],this.next=[],this.updating=!1}return t.prototype.update=function(){for(this.updating=!0,this.next=this.callbacks.slice();0<this.callbacks.length;)this.callbacks.shift()();return this.callbacks=this.next,this.updating=!1,this},t.prototype.addCallback=function(t){if(this.callbacks.includes(t)||this.callbacks.push(t),this.updating&&!this.next.includes(t))return this.next.push(t)},t.prototype.nextTick=function(t){return this.updating?this.next.includes(t)?void 0:this.next.push(t):this.addCallback(t)},t.prototype.removeCallback=function(t){var n;if(-1!==(n=this.callbacks.indexOf(t))&&this.callbacks.splice(n,1),-1!==(n=this.next.indexOf(t)))return this.next.splice(n,1)},t.prototype.getBinder=function(){return new t.Binder(this)},t.prototype.destroy=function(){return this.callbacks=[],this.next=[]},t}()).Binder=function(t){function n(t,n){this.target=t,this.callback=n,this.ref={target:this.target,callback:this.callback}}return y(n,e),n.prototype.doBind=function(){return this.target.addCallback(this.callback)},n.prototype.doUnbind=function(){return this.target.removeCallback(this.callback)},n}(),n},o.Updater=d(),o.Updater.definition=d}).call(this);